# Инструмент проактивного контроля SQL для PostgreSQL

### Оценка «стоимости» запроса до выполнения
- Анализ запроса через `AST`(Abstract Syntax Tree)
- Анализ плана выполнения (`EXPLAIN`) без запуска запроса.  
- Использование `EXPLAIN ANALYZE` (опционально) для прогноза времени, I/O.  

### Рекомендации по оптимизации
- Для SQL-запросов:
  - предложения по добавлению/изменению индексов,  
  - переписывание текста запроса,  
  - устранение N+1 проблем.  
- Классификация рекомендаций по приоритету: **high / medium / low**.  
- Оценка потенциального ускорения (в процентах).  
<!-- - Выявление шаблонов проблемных запросов через анализ логов и формирование профилактических мер. -->

### Интеграция с GitHub Actions
- При push и pull request
- Создаёт архив с выполненными анализами

## Метрики
- `pre_analyze` — анализ запроса без EXPLAIN, через AST, выявление антипаттернов на раннем этапе.  
- `post_analyze` — анализ запроса через EXPLAIN, ANALYZE (если указанно в настройках - settings.py).  
    - `issues` — проблемы запроса - риск, проблема, рекомендация.  
    - `volume` — объём сканируемых данных.  
    - `time` — время, за которое выполнился запрос (работает только в ANALYZE)
    - `total_cost` — стоимость выполнения запроса.  
- `statistic` — сбор статистики по самым ресурсно-затратным и частым запросам.

## Настройки (файл settings.py)
### Настройки никак не влияют на SQL запрос, они лишь ругаются, если результат вышел за пределы
- `LIMIT_ROWS`: максимальное количество возвращаемых строк. (по умолчанию 200)
- `MAX_ROWS_WITHOUT_INDEX`: допустимый предел строк в запросе без использования индексов (по умолчанию 10000).  
- `MAX_SORT_LIMIT`: верхняя граница количества строк для операций сортировки (по умолчанию 300000).  
- `MAKE_ANALYZE`: выполнять ли `EXPLAIN ANALYZE` (по умолчанию `False`).  
- `ANALYZE_TIMEOUT`: таймаут в секундах для выполнения `ANALYZE` (по умолчанию 3).  
- `MAX_PARAMS_IN_IN`: лимит параметров в операторе `IN` (по умолчанию 10).  
- `COUNT_FREQUENT_AND_VORACIOUS_REQUESTS`: сбор статистики по частым и ресурсоёмким запросам (по умолчанию 0).

## Как запустить приложение
```bash
pip install -r requirements.txt
```
### создать *.env* файл
- Пример:

```env
DB_NAME=test
DB_USER=postgres
DB_PASSWORD=123
DB_HOST=localhost
DB_PORT=5432

PORT=3000
```

### Есть 2 способа файлы/HTTP Сервер
### Файлы

- Написать SQL запросы в папке *queries* (**Неограниченное кол-во**)

```sql
-- Пример request.sql

SELECT * FROM users u
JOIN posts p ON u.id = p.user_id
```

```bash
py main.py
```

- Ответы находятся в папке *results* в формате **JSON**

### HTTP Сервер
- всего один эндпойнт **POST** /

```bash
# Запустить сервер(по умолчанию порт 3000)

py server.py
```

- Формат BODY запроса
```json
{
    "query": "SELECT * FROM users u JOIN posts p ON u.id = p.user_id"
}
```

## Пример ответа
```json
{
  "pre_analyze": [
    {
      "severity": "medium",
      "problem": "Используется * в FROM",
      "recommendation": "Указать конкретные поля, которые нужны, все поля: "
    }
  ],
  "post_analyze": {
    "query": "SELECT * FROM users u\nJOIN posts p ON u.id = p.user_id",
    "time": "3",
    "volume": {
      "posts": 4999933,
      "users": 1000000
    },
    "total_cost": 328746.09,
    "issues": [
      {
        "severity": "high",
        "problem": "JOIN проходится по всем рядам без индекса. Что сильно тормозит запрос",
        "recommendation": "Поставьте индекс на одну из колонок, использующихся в JOIN"
      },
      {
        "severity": "low",
        "problem": "Запрос выполняется дольше 3 секунд",
        "recommendation": "Улучшите оптимизацию"
      },
      {
        "severity": "medium",
        "problem": "Возврат большого кол-ва значений, сейчас установлен лимит 200. Запрос вернёт 4940201 полей",
        "recommendation": "Установить LIMIT и делать запросы с пагинацией(метод с курсором)"
      }
    ]
  },
  "statistic": [
    {
      "query_single_line": "SELECT set_config($1,$2,$3) FROM pg_show_all_settings() WHERE name = $4",
      "calls": 1,
      "total_exec_time": 9.0,
      "mean_exec_time": 9.0,
      "rows": 1
    }
  ]
}